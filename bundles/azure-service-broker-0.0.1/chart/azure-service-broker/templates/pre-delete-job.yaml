apiVersion: batch/v1
kind: Job
metadata:
    name: azure-service-broker-cleaner-job
    labels:
        app: {{ template "fullname" . }}
        chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
        release: "{{ .Release.Name }}"
        heritage: "{{ .Release.Service }}"
    annotations:
        "helm.sh/hook": pre-delete,pre-upgrade
        "helm.sh/hook-weight": "0"
        "helm.sh/hook-delete-policy": hook-succeeded
spec:
    backoffLimit: 1
    template:
        metadata:
            annotations:
                 sidecar.istio.io/inject: "false"
        spec:
            serviceAccountName: {{ template "fullname" . }}
            restartPolicy: Never
            containers:
                - name: broker-checker
                  image: "{{ .Values.jobs.kubectlImage.repository }}:{{ .Values.jobs.kubectlImage.tag }}"
                  imagePullPolicy: {{ .Values.jobs.kubectlImage.pullPolicy }}
                  command: ["/bin/sh","-c"]
                  args:
                    - |
                      set +o errexit
                      kubectl delete jobs -n {{ .Release.Namespace }} -l release={{ .Release.Name }}

                      deleteErr=$?
                      if [[ ${deleteErr} -ne 0 ]]
                      then
                        exit 1
                      fi
